dist: xenial
language: cpp
os: linux

jobs:
  include:
  - compiler: clang
    env:
    - CONF_OPTIONS="--enable-cplusplus"
    - WORKAROUND_ACLOCAL_MISSING=true
  - compiler: gcc
    env:
    - CONF_OPTIONS="--enable-cplusplus"
    - WORKAROUND_ACLOCAL_MISSING=true
  - os: osx
    env:
    - CONF_OPTIONS="--enable-cplusplus"
  - env:
    - MAKEFILE_TARGETS="dist"
    - WORKAROUND_ACLOCAL_MISSING=true
  - addons:
      apt:
        packages:
        - libatomic-ops-dev
    compiler: clang
    env:
    - CONF_OPTIONS="--enable-cplusplus"
    - NO_CLONE_LIBATOMIC_OPS=true
  - addons:
      apt:
        packages:
        - libatomic-ops-dev
    compiler: gcc
    env:
    - CONF_OPTIONS="--enable-gc-assertions --enable-cplusplus"
    - NO_CLONE_LIBATOMIC_OPS=true
  - compiler: clang
    env:
    - CONF_OPTIONS="--enable-gc-assertions"
    - WORKAROUND_ACLOCAL_MISSING=true
  - compiler: gcc
    env:
    - CONF_OPTIONS="--enable-gc-assertions"
    - WORKAROUND_ACLOCAL_MISSING=true
  - os: osx
    env:
    - CONF_OPTIONS="--enable-gc-assertions --enable-handle-fork --enable-cplusplus"
  - compiler: gcc
    env:
    - CONF_OPTIONS="--enable-gc-debug --enable-cplusplus"
    - WORKAROUND_ACLOCAL_MISSING=true
  - os: osx
    env:
    - CONF_OPTIONS="--enable-munmap --enable-cplusplus"
  - compiler: gcc
    env:
    - CONF_OPTIONS="--enable-handle-fork --enable-munmap --enable-cplusplus --disable-shared --enable-gc-assertions"
    - WORKAROUND_ACLOCAL_MISSING=true
  - compiler: gcc
    env:
    - CONF_OPTIONS="--disable-gc-debug --enable-cplusplus"
    - WORKAROUND_ACLOCAL_MISSING=true
  - compiler: clang
    env:
    - CONF_OPTIONS="--enable-large-config --enable-cplusplus"
    - WORKAROUND_ACLOCAL_MISSING=true
  - os: osx
    env:
    - CONF_OPTIONS="--enable-large-config --enable-cplusplus"
  - compiler: gcc
    env:
    - CONF_OPTIONS="--enable-large-config --disable-munmap"
    - WORKAROUND_ACLOCAL_MISSING=true
  - compiler: gcc
    env:
    - CONF_OPTIONS="--enable-large-config --enable-munmap --enable-cplusplus --enable-gc-assertions --enable-static"
    - WORKAROUND_ACLOCAL_MISSING=true
  - compiler: clang
    env:
    - CONF_OPTIONS="--enable-redirect-malloc --disable-threads"
    - WORKAROUND_ACLOCAL_MISSING=true
  - os: osx
    env:
    - CONF_OPTIONS="--enable-redirect-malloc --enable-cplusplus --disable-threads"
  - compiler: gcc
    env:
    - CONF_OPTIONS="--enable-redirect-malloc --enable-gc-debug --enable-cplusplus --enable-gc-assertions"
    - WORKAROUND_ACLOCAL_MISSING=true
  - compiler: clang
    env:
    - CONF_OPTIONS="--disable-static --disable-threads --enable-cplusplus"
    - WORKAROUND_ACLOCAL_MISSING=true
  - compiler: gcc
    env:
    - CONF_OPTIONS="--disable-static --disable-threads --enable-cplusplus"
    - WORKAROUND_ACLOCAL_MISSING=true
  - os: osx
    env:
    - CONF_OPTIONS="--disable-static --disable-threads --enable-cplusplus"
  - addons:
      apt:
        packages:
        - libatomic-ops-dev
    dist: focal
    env:
    - MAKEFILE_TARGETS="distcheck"
    - GC_REAL_VERSION=7.2s
    - AO_SRC_VER=v7.2l

before_install:
- if [[ "$MAKEFILE_TARGETS" == *"dist"* ]]; then
    autoconf --version;
    automake --version;
    m4 --version;
    libtool --version || true;
    pkg-config --version;
  fi
- if [[ "$MAKEFILE_TARGETS" == "" ]]; then MAKEFILE_TARGETS="check"; fi

install:
- if [[ "$NO_CLONE_LIBATOMIC_OPS" != true ]]; then
    if [[ "$AO_SRC_VER" == "" ]]; then AO_SRC_VER="release-7_2"; fi;
    git clone --depth=50 https://github.com/bdwgc/libatomic_ops.git
              -b $AO_SRC_VER;
  fi
- if [[ "$WORKAROUND_ACLOCAL_MISSING" == true ]]; then
    autoreconf --force --install;
  fi

script:
- ./configure $CONF_OPTIONS
- make -j $MAKEFILE_TARGETS
- if [[ "$GC_REAL_VERSION" != "" ]]; then
    tar xf gc-*.tar.gz;
    rm gc-*.tar.*;
    (cd gc-*; ln -s ../libatomic_ops);
    tar cf gc-$GC_REAL_VERSION.tar --dereference
        --exclude=".*" --exclude="*.yml" gc-*/;
    gzip --best --verbose gc-*.tar;
  fi

before_deploy:
- yes | gem update --system --force
- gem install bundler
- gem install uri
- gem install logger

deploy:
  provider: releases
  edge: true
  file: gc-*.tar.gz
  file_glob: true
  on:
    condition: $MAKEFILE_TARGETS = distcheck
    repo: bdwgc/bdwgc
    tags: true
